{% extends 'base_auth.html' %}

{% block app_content %}

    <div class="container-fluid">
        <!-- start of tabs -->


        <div class="row hidden-xs">
            <div class="col-lg-12">

            </div>
        </div>

        <!-- end of tabs -->
        <div class="row">
            <div class="col-lg-12">

            </div>
            <!-- /.col-lg-12 -->
        </div>
        <!-- /.row -->
        <div class="row">
            <div id="base-content" class="col-lg-12">


                <div class="row">
                    <div class="col-md-12">
                        <div class="panel panel-default">
                            <div class="panel-heading tight">
                                <h3 class="has-filters">
                                    Messages

                                </h3>
                            </div>

                        </div>

                        <div class="clearfix"></div>

                        {% include "pagination_tab_all.html" %}

                        <div class="table-responsive panel panel-default">

                            <table id="endpoints" aria-describedby="Component Table"
                                   class="tablesorter-bootstrap table table-condensed table-striped table-hover">
                                <tbody>



                                <tr>
                                    <input type="hidden" id="val_page" value="{{ table_details['page'] }}">
                                    <input type="hidden" id="val_per_page" value="{{ table_details['per_page'] }}">
                                    <input type="hidden" id="val_orderby" value="{{ table_details['orderby'] }}">



                                    <th>Add Date</th>
                                    <th class="text-center">Message Type</th>
                                    <th>From</th>
                                    <th>Message</th>
                                    <th></th>
                                    <th></th>
                                    <th></th>
                                </tr>

                                {% for i in entities %}
                                <tr>


                                    <td>
                                        {{ i.AddDate }}
                                    </td>

                                    <td class="text-center">
                                        {{ i.MessageType }}
                                    </td>
                                    <td>
                                       {% if i.username == user.username%}System{% else %}{{ i.username }}{% endif %}
                                    </td>
                                    <td>
                                       {{ i.Message[0:19] }}
                                    </td>
                                    <td>
                                        <div data-toggle="modal" data-target="#messageModal{{ i.ID }}">
                                            <div class="fa fa-info-circle"></div>
                                        </div>
                                    </td>
                                    <td>
                                       {% if i.EntityType == 'Vulnerability' %}
                                       <a href="/finding/{{ i.ApplicationId }}/{{ i.EntityID }}">
                                           <div class="fa-solid fa-toolbox"></div>
                                       </a>
                                       {% endif %}
                                    </td>
                                    <td>
                                        <div data-toggle="modal" data-target="#deleteModal-{{ i.ID }}">
                                            <div class="fa-solid fa-trash"></div>
                                        </div>
                                    </td>

                                </tr>
                                {% endfor %}

                                </tbody>
                            </table>

                            {% for i in entities %}

                            <!-- Modal -->
                            <div class="modal fade" id="messageModal{{ i.ID }}" tabindex="-1" aria-labelledby="messageModalLabel{{ i.ID }}" aria-hidden="true">
                                <div class="modal-dialog modal-dialog-centered">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="messageModalLabel{{ i.ID }}">Full Message</h5>

                                        </div>
                                        <div class="modal-body">
                                            {{ i.Message }}
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Delete Confirmation Modal -->
                            <div class="modal fade" id="deleteModal-{{i.ID}}" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
                                <div class="modal-dialog" role="document">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </div>
                                        <div class="modal-body">
                                            Are you sure you want to delete this message? This action is irreversible.
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                            <button type="button" class="btn btn-danger" onclick="deleteMsg({{i.ID}})">Delete</button>
                                        </div>
                                    </div>
                                </div>
                            </div>



                            {% endfor %}



                        </div>
                        <div class="clearfix"></div>

                        {% include "pagination_tab_all.html" %}

                    </div>
                </div>


            </div>
            <!-- /.col-lg-12 -->
        </div>
    </div>



<script>
function deleteMsg(msg_id) {
    var xhttp = new XMLHttpRequest();
    var csrf_token = "{{ csrf_token() }}";
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
        location.reload();
    }
  };
  xhttp.open("POST", "/suppress_msg", true);
  xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
  xhttp.setRequestHeader("X-CSRF-Token", csrf_token);
  xhttp.send("msg_id=" + msg_id);
}

function updatePerPage(new_per_page) {
    var cur_page = document.getElementById('val_page').value;
    var cur_per_page = document.getElementById('val_per_page').value;
    var cur_orderby = document.getElementById('val_orderby').value;
    var xhttp = new XMLHttpRequest();
    var csrf_token = "{{ csrf_token() }}";
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
        var resp = this.responseText;
        document.body.parentElement.innerHTML = resp;
    }
  };
  xhttp.open("POST", "/messages", true);
  xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
  xhttp.setRequestHeader("X-CSRF-Token", csrf_token);
  xhttp.send("cur_page=" + cur_page + "&cur_per_page=" + cur_per_page + "&cur_orderby=" + cur_orderby + "&new_per_page=" + new_per_page);
}

function updatePagination(new_page) {
    var cur_page = document.getElementById('val_page').value;
    var cur_per_page = document.getElementById('val_per_page').value;
    var cur_orderby = document.getElementById('val_orderby').value;
    var xhttp = new XMLHttpRequest();
    var csrf_token = "{{ csrf_token() }}";
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
        var resp = this.responseText;
        document.body.parentElement.innerHTML = resp;
    }
  };
  xhttp.open("POST", "/messages", true);
  xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
  xhttp.setRequestHeader("X-CSRF-Token", csrf_token);
  xhttp.send("cur_page=" + cur_page + "&cur_per_page=" + cur_per_page + "&cur_orderby=" + cur_orderby + "&new_page=" + new_page);
}

function fieldSorter(field_name, new_dir) {
    var cur_page = document.getElementById('val_page').value;
    var cur_per_page = document.getElementById('val_per_page').value;
    var cur_orderby = document.getElementById('val_orderby').value;
    var xhttp = new XMLHttpRequest();
    var csrf_token = "{{ csrf_token() }}";
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
        var resp = this.responseText;
        document.body.parentElement.innerHTML = resp;
    }
  };
  xhttp.open("POST", "/messages", true);
  xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
  xhttp.setRequestHeader("X-CSRF-Token", csrf_token);
  xhttp.send("field_name=" + field_name + "&cur_page=" + cur_page + "&cur_per_page=" + cur_per_page + "&cur_orderby=" + cur_orderby + "&new_dir=" + new_dir);
}
</script>

{% endblock %}
