{% extends 'base_auth.html' %}

{% block app_content %}
<style>
.pagination {
    color: black;
}
</style>

    <div class="container-fluid">
    <!-- start of tabs -->
    <div class="row">
        <div class="col-md-12 active">
            <h3 class="no-margin-top" style="padding-bottom: 5px;color: floralwhite;">
                {{ app_data.ApplicationName }}:{{ app_data.Component }}

            </h3>
            {% include "assets/component_horizontal_bar.html" %}
        </div>
    </div>


    <!-- end of tabs -->
    <div class="row">
        <div class="col-lg-12">

        </div>
        <!-- /.col-lg-12 -->
    </div>
    <!-- /.row -->
    <div class="row">
        <div id="base-content" class="col-lg-12">
            <div class="row">
                <div class="col-md-12">
                    <div class="panel panel-default" style="color: black;">
                        <div class="panel-heading tight">
                            <h4 class="has-filters">
                                CI/CD Pipeline Security Assessments ({{ table_details['item_tot'] }})
                                <div class="dropdown pull-right">
                                    <button class="btn btn-primary dropdown-toggle" type="button" id="dropdownMenu1"
                                            aria-label="Add Engagement" data-toggle="dropdown" aria-expanded="true">
                                        <span class="fa fa-bars"></span>
                                        <span class="caret"></span>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-right" role="menu"
                                        aria-labelledby="dropdownMenu1">
                                        <li role="presentation">
                                            <a class="" href="/add_cicd_pipeline_stage">
                                                <div class="fa fa-plus"></div> Add New CI/CD Stage
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </h4>
                        </div>

                        {% include "pagination_tab.html" %}

                        <div class="panel panel-default table-responsive">
                            <div id="open_wrapper" class="dataTables_wrapper form-inline dt-bootstrap no-footer">
                                <table id="open" aria-describedby="Component Table"
                                       class="tablesorter-bootstrap table table-condensed table-striped table-hover dataTable no-footer">
                                    <thead>
                                    <tr>
                                        <input type="hidden" id="val_page" value="{{ table_details['page'] }}">
                                        <input type="hidden" id="val_per_page" value="{{ table_details['per_page'] }}">
                                        <input type="hidden" id="val_orderby" value="{{ table_details['orderby'] }}">

                                        <th class="noVis sorting_disabled sorting_asc" rowspan="1" colspan="1" style="width: 1px;"
                                            data-column-index="0" aria-label=""></th>
                                        <th onclick="fieldSorter({{ app_data.ID }}, 'ScanName', 'dynamic')"
                                             class="nowrap centered sorting" tabindex="0" aria-controls="open" rowspan="1" colspan="1"
                                            style="width: 47.25px;" data-column-index="1"
                                            aria-label="Name&amp;nbsp;: activate to sort column ascending"><a
                                                    title="Click to sort descending"
                                                    href="#">Name&nbsp;<div class="fa fa-sort dd-sort"></div></a></th>
                                        <th onclick="fieldSorter({{ app_data.ID }}, 'ScanType', 'dynamic')"
                                             class="nowrap centered sorting" tabindex="0" aria-controls="open" rowspan="1" colspan="1"
                                            style="width: 47.25px;" data-column-index="1"
                                            aria-label="Type&amp;nbsp;: activate to sort column ascending"><a
                                                    title="Click to sort descending"
                                                    href="#">Type&nbsp;<div class="fa fa-sort dd-sort"></div></a></th>
                                        <th onclick="fieldSorter({{ app_data.ID }}, 'ScanStartDate', 'dynamic')"
                                             class="nowrap centered sorting" tabindex="0" aria-controls="open" rowspan="1" colspan="1"
                                            style="width: 47.25px;" data-column-index="1"
                                            aria-label="Date&amp;nbsp;: activate to sort column ascending"><a
                                                    title="Click to sort descending"
                                                    href="#">Date&nbsp;<div class="fa fa-sort dd-sort"></div></a></th>
                                        <th class="text-center sorting" tabindex="0" aria-controls="open" rowspan="1"
                                            colspan="1" style="width: 64px;" data-column-index="7"
                                            aria-label="Active (Verified): activate to sort column ascending">Active
                                        </th>
                                        <th class="text-center sorting" tabindex="0" aria-controls="open" rowspan="1"
                                            colspan="1" style="width: 66px;" data-column-index="8"
                                            aria-label="Mitigated: activate to sort column ascending">Mitigated
                                        </th>
                                        <th class="text-center sorting" tabindex="0" aria-controls="open" rowspan="1"
                                            colspan="1" style="width: 66px;" data-column-index="9"
                                            aria-label="Accepted: activate to sort column ascending">Accepted
                                        </th>
                                        <th class="text-center sorting" tabindex="0" aria-controls="open" rowspan="1"
                                            colspan="1" style="width: 17px;" data-column-index="10"
                                            aria-label="All: activate to sort column ascending">All
                                        </th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for i in entities %}
                                    <tr class="odd">
                                        <td class="nowrap sorting_1">

                                        </td>
                                        <td style="width: 250px;"><a href="/open_findings_for_scan/{{ app_data.ID }}/{{ i.ID }}" data-toggle="tooltip"
                                                                     data-placement="bottom"
                                                                     title="{{ i.ScanName }}">
                                            {{ i.ScanName }}</a></td>
                                        <td class="text-center" >{{ i.ScanType }}</td>
                                        <td class="text-center" style="width: 200px;"><a target="#" data-toggle="tooltip"
                                                                                       data-placement="bottom"
                                                                                       title="{{ i.ScanStartDate }}">
                                            {{ i.ScanStartDate }}
                                        </a></td>

                                        <td class="text-center">{{ i.open_issue_cnt }}</td>
                                        <td class="text-center">{{ i.closed_issue_cnt }}</td>
                                        <td class="text-center">{{ i.ra_issue_cnt }}</td>
                                        <td class="text-center">{{ i.issue_cnt }}</td>


                                    </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {% include "pagination_tab.html" %}
                    </div>
                </div>

                <script>
                    // DataTables setup
                    $(document).ready(function () {
                        var date = new Date().toISOString().slice(0, 10);
                        var fileDated = 'Engagements_List_' + date;
                        var buttonCommon = {
                            exportOptions: {
                                columns: ':not(:eq(8))',
                                stripHtml: true,
                                stripNewlines: true,
                                trim: true,
                                orthogonal: 'export'
                            },
                            filename: fileDated,
                            title: 'Engagements List'
                        };

                        // Mapping of table columns to objects for proper cleanup and data formatting
                        var dojoTable = $('#open').DataTable({
                            colReorder: true,
                            "columns": [
                                {"data": "action"},
                                {"data": "eng_name"},
                                {"data": "engagement_type"},
                                {"data": "lead"},
                                {"data": "date"},
                                {"data": "length"},

                                {"data": "tests"},
                                {"data": "open"},
                                {"data": "mitigated"},
                                {"data": "accepted"},
                                {"data": "all"},
                                {"data": "dups"},

                            ],
                            columnDefs: [
                                {
                                    "orderable": false,
                                    "targets": [0]
                                },
                            ],
                            dom: 'Bfrtip',
                            paging: false,
                            info: false,
                            buttons: [
                                {
                                    extend: 'colvis',
                                    columns: ':not(.noVis)'
                                },
                                $.extend(true, {}, buttonCommon, {
                                    extend: 'copy'
                                }),
                                $.extend(true, {}, buttonCommon, {
                                    extend: 'excel',
                                    autoFilter: true,
                                    sheetName: 'Exported data',
                                }),
                                $.extend(true, {}, buttonCommon, {
                                    extend: 'csv'
                                }),
                                $.extend(true, {}, buttonCommon, {
                                    extend: 'pdf',
                                    orientation: 'landscape',
                                    pageSize: 'LETTER'
                                }),
                                $.extend(true, {}, buttonCommon, {
                                    extend: 'print'
                                }),
                            ],
                        });
                    });
                </script>





            </div>
            <div class="protip">

            </div>

        </div>
        <!-- /.col-lg-12 -->
    </div>
</div>

<script>
function updatePerPage(app_id, new_per_page) {
    var cur_page = document.getElementById('val_page').value;
    var cur_per_page = document.getElementById('val_per_page').value;
    var cur_orderby = document.getElementById('val_orderby').value;
    var xhttp = new XMLHttpRequest();
    var csrf_token = "{{ csrf_token() }}";
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
        var resp = this.responseText;
        document.body.parentElement.innerHTML = resp;
    }
  };
  xhttp.open("POST", "/vulnerability_scans/" + app_id, true);
  xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
  xhttp.setRequestHeader("X-CSRF-Token", csrf_token);
  xhttp.send("cur_page=" + cur_page + "&cur_per_page=" + cur_per_page + "&cur_orderby=" + cur_orderby + "&new_per_page=" + new_per_page);
}

function updatePagination(app_id, new_page) {
    var cur_page = document.getElementById('val_page').value;
    var cur_per_page = document.getElementById('val_per_page').value;
    var cur_orderby = document.getElementById('val_orderby').value;
    var xhttp = new XMLHttpRequest();
    var csrf_token = "{{ csrf_token() }}";
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
        var resp = this.responseText;
        document.body.parentElement.innerHTML = resp;
    }
  };
  xhttp.open("POST", "/vulnerability_scans/" + app_id, true);
  xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
  xhttp.setRequestHeader("X-CSRF-Token", csrf_token);
  xhttp.send("cur_page=" + cur_page + "&cur_per_page=" + cur_per_page + "&cur_orderby=" + cur_orderby + "&new_page=" + new_page);
}

function fieldSorter(app_id, field_name, new_dir) {
    var cur_page = document.getElementById('val_page').value;
    var cur_per_page = document.getElementById('val_per_page').value;
    var cur_orderby = document.getElementById('val_orderby').value;
    var xhttp = new XMLHttpRequest();
    var csrf_token = "{{ csrf_token() }}";
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
        var resp = this.responseText;
        document.body.parentElement.innerHTML = resp;
    }
  };
  xhttp.open("POST", "/vulnerability_scans/" + app_id, true);
  xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
  xhttp.setRequestHeader("X-CSRF-Token", csrf_token);
  xhttp.send("field_name=" + field_name + "&cur_page=" + cur_page + "&cur_per_page=" + cur_per_page + "&cur_orderby=" + cur_orderby + "&new_dir=" + new_dir);
}
</script>


{% endblock %}